<%- include('./partials/header') %>
<%- include('./partials/main_nav') %>

<div class="calendar-page container-fluid py-4">

  <!-- Page header -->
  <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">

    <!--Left view: month + navigation -->
    <div class="d-flex align-items-center gap-3">
      <button class="icon-button" id="prevRangeBtn" type="button" aria-label="Previous range">
        <i class="fas fa-chevron-left"></i>
      </button>

      <div class="d-flex flex-column">
        <span id="calendarMonthLabel" class="calendar-month-label">May 2025</span>
        <button class="link-button text-muted" id="todayBtn" type="button">
          Today
        </button>
      </div>

      <button class="icon-button" id="nextRangeBtn" type="button" aria-label="Next range">
        <i class="fas fa-chevron-right"></i>
      </button>
    </div>

    <!-- Right view: view switch + new event -->
    <div class="d-flex align-items-center gap-3 flex-wrap">

      <div class="view-switch btn-group btn-group-sm" role="group" aria-label="Calendar view">
        <button type="button" class="btn view-btn" data-view="1w">1 Week</button>
        <button type="button" class="btn view-btn active" data-view="2w">2 Weeks</button>
        <button type="button" class="btn view-btn" data-view="month">1 Month</button>
      </div>

      <button id="addEventBtn" type="button" class="btn btn-primary btn-sm">
        <i class="fas fa-plus me-1"></i> New Event
      </button>
    </div>
  </div>

  <!-- Calendar grid -->
  <div id="calendarGrid" class="calendar-grid mb-3">
  <! -- use javascript to populate fill -->
  </div>

  <p class="small text-muted mb-0">
    This is a shared calendar. Events are stored on MongoDB and visible to all users, so everyone
    has the same schedule.
  </p>
</div>

<!-- Event modal -->
<div class="modal fade" id="eventModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <form class="modal-content" id="eventForm">
      <div class="modal-header">
        <h5 class="modal-title" id="eventModalTitle">New Event</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <input type="hidden" id="eventId">

        <div class="mb-3">
          <label for="eventTitle" class="form-label">Title</label>
          <input type="text" id="eventTitle" class="form-control" placeholder="Meeting with client" required>
        </div>

        <div class="row g-3">
          <div class="col-md-6 mb-3 mb-md-0">
            <label for="eventDate" class="form-label">Date</label>
            <input type="date" id="eventDate" class="form-control" required>
          </div>
          <div class="col-md-6">
            <label for="eventTime" class="form-label">Time</label>
            <input type="time" id="eventTime" class="form-control">
          </div>
        </div>

        <div class="row g-3 mt-1">
          <div class="col-md-6 mb-3 mb-md-0">
            <label for="eventOwner" class="form-label">Who is this for?</label>
            <input
              type="text"
              id="eventOwner"
              class="form-control"
              placeholder="e.g. Design team"
              value="<%= user ? user.email : '' %>">
          </div>

          <div class="col-md-6">
            <label for="eventTags" class="form-label">Tags (comma‑separated)</label>
            <input
              type="text"
              id="eventTags"
              class="form-control"
              placeholder="Lecture, Tutorial, Case study">
          </div>
        </div>

        <div class="mt-3">
          <label for="eventNotes" class="form-label">Notes (optional)</label>
          <textarea id="eventNotes" class="form-control" rows="2"></textarea>
        </div>
      </div>

      <div class="modal-footer d-flex justify-content-between">
        <button type="button" class="btn btn-outline-danger d-none" id="deleteEventBtn">
          Delete
        </button>

        <div class="ms-auto">
          <button type="button" class="btn btn-outline-secondary me-2" data-bs-dismiss="modal">
            Cancel
          </button>
          <button type="submit" class="btn btn-primary">
            Save
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<script>
  // Everything Schedule view in this blocK
  window.addEventListener('DOMContentLoaded', function () {
    //  DOM references 
    const calendarGrid   = document.getElementById('calendarGrid');
    const monthLabel     = document.getElementById('calendarMonthLabel');
    const todayBtn       = document.getElementById('todayBtn');
    const prevRangeBtn   = document.getElementById('prevRangeBtn');
    const nextRangeBtn   = document.getElementById('nextRangeBtn');
    const viewButtons    = document.querySelectorAll('.view-btn');
    const addEventBtn    = document.getElementById('addEventBtn');

    // Modal + form ref
    const eventModalEl   = document.getElementById('eventModal');
    const eventModal     = eventModalEl && window.bootstrap
                            ? window.bootstrap.Modal.getOrCreateInstance(eventModalEl)
                            : null;
    const eventForm      = document.getElementById('eventForm');
    const eventModalTitle= document.getElementById('eventModalTitle');
    const deleteEventBtn = document.getElementById('deleteEventBtn');

    // Form fields
    const inputId        = document.getElementById('eventId');
    const inputTitle     = document.getElementById('eventTitle');
    const inputDate      = document.getElementById('eventDate');
    const inputTime      = document.getElementById('eventTime');
    const inputOwner     = document.getElementById('eventOwner');
    const inputTags      = document.getElementById('eventTags');
    const inputNotes     = document.getElementById('eventNotes');

    if (!calendarGrid) {
      // Not on schedule page
      return;
    }

    // Small date helpER
    const STORAGE_KEY = 'plansimple.sharedCalendar.events';

    function startOfWeek(date) {
      const d = new Date(date);
      d.setHours(0, 0, 0, 0);
      const day = d.getDay(); // 0 = Sunday
      d.setDate(d.getDate() - day);
      return d;
    }

    function addDays(date, days) {
      const d = new Date(date);
      d.setDate(d.getDate() + days);
      return d;
    }

    function isoDate(date) {
      return date.toISOString().slice(0, 10);
    }

    function daysInMonth(date) {
      return new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
    }

    function monthLabelText(start, end) {
      const sameMonth = start.getMonth() === end.getMonth() &&
                        start.getFullYear() === end.getFullYear();
      const full = { month: 'long', year: 'numeric' };
      if (sameMonth) {
        return start.toLocaleDateString(undefined, full);
      }
      const short = { month: 'short' };
      return start.toLocaleDateString(undefined, short) +
             ' – ' +
             end.toLocaleDateString(undefined, full);
    }

    // Load & save events ON localStorage
    function loadEvents() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed : [];
      } catch (err) {
        console.warn('Could not load events:', err);
        return [];
      }
    }

    function saveEvents() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(events));
    }

    //  In‑memory state 
    let events   = loadEvents();
    let viewMode = '2w'; // '1w' | '2w' | 'month'
    let anchor   = new Date(); //SET to today initially

    // Calendar rendering 
    function currentRange() {
      if (viewMode === 'month') {
        const firstOfMonth = new Date(anchor.getFullYear(), anchor.getMonth(), 1);
        const total = daysInMonth(firstOfMonth);
        const start = firstOfMonth;
        const end = addDays(start, total - 1);
        return { start, totalDays: total, end };
      }

      const start = startOfWeek(anchor);
      const totalDays = viewMode === '1w' ? 7 : 14;
      const end = addDays(start, totalDays - 1);
      return { start, totalDays, end };
    }

    function renderCalendar() {
      const { start, totalDays, end } = currentRange();
      monthLabel.textContent = monthLabelText(start, end);
      calendarGrid.innerHTML = '';
      calendarGrid.style.gridTemplateColumns = 'repeat(7, minmax(0, 1fr))';

      const todayIso = isoDate(new Date());

      for (let i = 0; i < totalDays; i++) {
        const dayDate = addDays(start, i);
        const dayIso  = isoDate(dayDate);
        const dayName = dayDate.toLocaleDateString(undefined, { weekday: 'short' });
        const dayNum  = dayDate.getDate();

        // Outer day cell
        const dayEl = document.createElement('div');
        dayEl.className = 'calendar-day';
        if (dayIso === todayIso) {
          dayEl.classList.add('is-today');
        }

        // Day header
        const header = document.createElement('div');
        header.className = 'calendar-day-header';

        const left = document.createElement('div');
        left.className = 'calendar-day-header-main';

        const nameSpan = document.createElement('span');
        nameSpan.className = 'calendar-day-name';
        nameSpan.textContent = dayName.toUpperCase();

        const numSpan = document.createElement('span');
        numSpan.className = 'calendar-day-number';
        numSpan.textContent = String(dayNum).padStart(2, '0');

        left.appendChild(nameSpan);
        left.appendChild(numSpan);

        header.appendChild(left);
        dayEl.appendChild(header);

        // Events container
        const eventsCol = document.createElement('div');
        eventsCol.className = 'calendar-events';

        const dayEvents = events
          .filter(e => e.date === dayIso)
          .sort((a, b) => (a.time || '').localeCompare(b.time || ''));

        dayEvents.forEach(ev => {
          const card = document.createElement('button');
          card.type = 'button';
          card.className = 'calendar-event';
          card.dataset.id = ev.id;

          const meta = document.createElement('div');
          meta.className = 'event-meta';

          if (ev.time) {
            const t = document.createElement('span');
            t.className = 'event-time';
            t.textContent = ev.time;
            meta.appendChild(t);
          }

          if (ev.tags && ev.tags.length) {
            ev.tags.forEach(tag => {
              const tagEl = document.createElement('span');
              tagEl.className = 'event-tag';
              tagEl.textContent = tag;
              meta.appendChild(tagEl);
            });
          }

          card.appendChild(meta);

          const title = document.createElement('div');
          title.className = 'event-title';
          title.textContent = ev.title;
          card.appendChild(title);

          if (ev.owner) {
            const owner = document.createElement('div');
            owner.className = 'event-owner';
            owner.textContent = ev.owner;
            card.appendChild(owner);
          }

          card.addEventListener('click', function () {
            openForEdit(ev.id);
          });

          eventsCol.appendChild(card);
        });

        const addLink = document.createElement('button');
        addLink.type = 'button';
        addLink.className = 'add-event-link';
        addLink.textContent = '+ Add';
        addLink.addEventListener('click', function () {
          openForCreate(dayIso);
        });
        eventsCol.appendChild(addLink);

        dayEl.appendChild(eventsCol);
        calendarGrid.appendChild(dayEl);
      }
    }

    //Modal open helpers
    function fillForm(ev) {
      inputId.value    = ev ? ev.id : '';
      inputTitle.value = ev ? ev.title : '';
      inputDate.value  = ev ? ev.date : isoDate(anchor);
      inputTime.value  = ev ? ev.time || '' : '';
      inputOwner.value = ev ? (ev.owner || '') : inputOwner.value;
      inputTags.value  = ev && ev.tags ? ev.tags.join(', ') : '';
      inputNotes.value = ev ? (ev.notes || '') : '';
    }

    function openForCreate(preselectedDateIso) {
      const today = preselectedDateIso || isoDate(new Date());
      const newEv = {
        id: '',
        title: '',
        date: today,
        time: '',
        owner: inputOwner.value || '<%= user ? user.email : "" %>',
        tags: [],
        notes: ''
      };

      deleteEventBtn.classList.add('d-none');
      eventModalTitle.textContent = 'New Event';
      fillForm(newEv);
      if (eventModal) eventModal.show();
    }

    function openForEdit(id) {
      const ev = events.find(e => e.id === id);
      if (!ev) return;

      deleteEventBtn.classList.remove('d-none');
      eventModalTitle.textContent = 'Edit Event';
      fillForm(ev);
      if (eventModal) eventModal.show();
    }


    //Form submit+ delete
    eventForm.addEventListener('submit', function (e) {
      e.preventDefault();

      const id = inputId.value || String(Date.now());
      const title = inputTitle.value.trim();
      const date = inputDate.value;
      const time = inputTime.value;
      const owner = inputOwner.value.trim();
      const tags = inputTags.value
        .split(',')
        .map(t => t.trim())
        .filter(Boolean);
      const notes = inputNotes.value.trim();

      if (!title || !date) {
        alert('Please provide at least a title and a date.');
        return;
      }

      const existingIdx = events.findIndex(e => e.id === id);
      const newEvent = { id, title, date, time, owner, tags, notes };

      if (existingIdx >= 0) {
        events[existingIdx] = newEvent;
      } else {
        events.push(newEvent);
      }


      saveEvents();
      if (eventModal) eventModal.hide();
      renderCalendar();
    });

    deleteEventBtn.addEventListener('click', function () {
      const id = inputId.value;
      if (!id) return;

      events = events.filter(e => e.id !== id);
      saveEvents();
      if (eventModal) eventModal.hide();
      renderCalendar();
    });

    //Navigation buttons
    function shiftRange(direction) {
      if (viewMode === 'month') {
        anchor = new Date(anchor.getFullYear(), anchor.getMonth() + direction, 15);
      } else {
        const weeks = viewMode === '1w' ? 1 : 2;
        anchor = addDays(anchor, direction * weeks * 7);
      }
      renderCalendar();
    }

    prevRangeBtn.addEventListener('click', function () {
      shiftRange(-1);
    });

    nextRangeBtn.addEventListener('click', function () {
      shiftRange(1);
    });

    todayBtn.addEventListener('click', function () {
      anchor = new Date();
      renderCalendar();
    });

    addEventBtn.addEventListener('click', function () {
      openForCreate(isoDate(anchor));
    });

    viewButtons.forEach(btn => {
      btn.addEventListener('click', function () {
        viewButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        viewMode = btn.dataset.view;
        renderCalendar();
      });
    });
    // Initial render
    renderCalendar();
  });
</script>


<%- include('./partials/footer') %>
